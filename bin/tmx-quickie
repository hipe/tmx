#!/usr/bin/env ruby -w

require_relative '../lib/skylab'
require 'skylab/test-support/core'

program = -> i, o, e, pn_a, argv, & p do

  dae = Skylab::TestSupport::Quickie.start_daemon_using(
    i, o, e, pn_a )

  _ok = if p
    p[ dae ]
  else
    true
  end

  if _ok

    x = dae.receive_argv argv
    if x.nil?
      0
    else
      x
    end
  end
end

if __FILE__ == $PROGRAM_NAME

  exit( program.call( $stdin, $stdout, $stderr, [ $PROGRAM_NAME ], ARGV ) do | dae |
    dae.listen
  end )

else
  Skylab::Quickie = program
end
